<!-- 修改密码页面内容片段 -->
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0">
                    <i class="fas fa-key me-2"></i>修改密码
                </h4>
            </div>
                <div class="card-body p-4">
                    <!-- 消息显示区域 -->
                    <div id="change-password-messages"></div>
                    
                    <form method="post" 
                          hx-post="{% url 'change_password' %}" 
                          hx-target="#main-content" 
                          hx-swap="innerHTML" 
                          hx-push-url="true"
                          hx-on::before-request="setFormSubmitting(this, true)"
                          hx-on::after-request="setFormSubmitting(this, false)"
                          hx-on::response-error="setFormSubmitting(this, false); showMessage('请求失败，请重试', 'danger')">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="old_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>当前密码
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input type="password" 
                                       class="form-control" 
                                       id="old_password" 
                                       name="old_password" 
                                       placeholder="请输入当前密码"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePassword('old_password')">
                                    <i class="fas fa-eye" id="old_password-toggle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_password1" class="form-label">
                                <i class="fas fa-key me-1"></i>新密码
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-key"></i>
                                </span>
                                <input type="password" 
                                       class="form-control" 
                                       id="new_password1" 
                                       name="new_password1" 
                                       placeholder="请输入新密码"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePassword('new_password1')">
                                    <i class="fas fa-eye" id="new_password1-toggle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_password2" class="form-label">
                                <i class="fas fa-shield-alt me-1"></i>确认新密码
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-shield-alt"></i>
                                </span>
                                <input type="password" 
                                       class="form-control" 
                                       id="new_password2" 
                                       name="new_password2" 
                                       placeholder="请再次输入新密码"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePassword('new_password2')">
                                    <i class="fas fa-eye" id="new_password2-toggle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <span class="btn-text">
                                    <i class="fas fa-save me-2"></i>修改密码
                                </span>
                                <span class="btn-spinner d-none">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    修改中...
                                </span>
                            </button>
                        </div>
                    </form>
                    
                    <div class="text-center">
                        <p class="text-muted mb-0">
                            <a href="{% url 'home' %}" 
                               class="text-decoration-none"
                               hx-get="{% url 'home' %}"
                               hx-target="#main-content"
                               hx-swap="innerHTML"
                               hx-push-url="true">
                                <i class="fas fa-arrow-left me-1"></i>返回主页
                            </a>
                        </p>
                    </div>
                </div>
            </div>
    </div>
</div>

<script>
    // 密码修改成功后的处理
    document.addEventListener('DOMContentLoaded', function() {
        // 移除导航栏更新代码，避免重复渲染
        // 导航栏状态由base.html统一管理
        
        // 密码强度检查
        const newPassword = document.getElementById('id_new_password1');
        const confirmPassword = document.getElementById('id_new_password2');
        const strengthIndicator = document.createElement('div');
        strengthIndicator.className = 'password-strength mt-2';
        
        if (newPassword) {
            newPassword.parentNode.appendChild(strengthIndicator);
            
            newPassword.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let feedback = [];
                
                if (password.length >= 8) strength++;
                else feedback.push('至少8个字符');
                
                if (/[a-z]/.test(password)) strength++;
                else feedback.push('包含小写字母');
                
                if (/[A-Z]/.test(password)) strength++;
                else feedback.push('包含大写字母');
                
                if (/[0-9]/.test(password)) strength++;
                else feedback.push('包含数字');
                
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                else feedback.push('包含特殊字符');
                
                const strengthText = ['很弱', '弱', '一般', '强', '很强'][strength];
                const strengthColor = ['danger', 'warning', 'info', 'success', 'success'][strength];
                
                strengthIndicator.innerHTML = `
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-${strengthColor}" style="width: ${(strength/5)*100}%"></div>
                    </div>
                    <small class="text-${strengthColor}">密码强度: ${strengthText}</small>
                    ${feedback.length > 0 ? `<small class="text-muted d-block">建议: ${feedback.join(', ')}</small>` : ''}
                `;
            });
        }
        
        // 密码确认检查
        if (confirmPassword) {
            confirmPassword.addEventListener('input', function() {
                const match = this.value === newPassword.value;
                this.classList.toggle('is-valid', match && this.value.length > 0);
                this.classList.toggle('is-invalid', !match && this.value.length > 0);
            });
        }
    });
</script>